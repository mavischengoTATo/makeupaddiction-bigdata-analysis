<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>7549b90520d24755a3810b619129b599</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div id="89a361fe-6b56-472a-afb1-762fec6f1cc9" class="cell markdown"
data-jupyter="{&quot;outputs_hidden&quot;:true}" data-tags="[]">
<h2 id="business-goal">Business Goal</h2>
</div>
<div id="3ca40157-ac7c-4c92-a68d-e4b70bc7560a" class="cell markdown">
<p>Enhance the reach and impact of content shared on "MakeupAddiction"
by predicting the popularity of posts, thus enabling creators and brands
to engage more effectively with their audience.In this section, our
primary focus will be on predicting the score of a submission. By
analyzing the contributing factors to the model, we aim to impart
insights into what is crucial when posting high-score in the
MakeupAddiction subreddit.</p>
</div>
<div id="7118c4f6-1fba-45ee-908c-756f726b25de" class="cell markdown">
<h2 id="technical-goal">Technical Goal</h2>
</div>
<div id="a140b40b-feba-49e0-91dd-de9d19bd5fef" class="cell markdown">
<p>We will extract and engineer several features from our dataset: Post
Length, Makeup Theme, Posting Hour, Categorical Features, Creator
Popularity, and Text Length. A Gradient Boosted Regressor and Random
Forest Regressor will be employed as the supervised regression model,
trained on these features with the objective of predicting the
<code>score</code> of a post, which serves as our popularity metric. We
will partition the data into training and validation sets to evaluate
the modelâ€™s generalizability. Performance will be assessed using the
root-mean-square error (RMSE) metric and R Square metric. Lower RMSE
scores will be indicative of more accurate predictions of post
popularity. Higher R square means larger proportion of the variability
in the target variable is accounted for by the model.This strategy aims
to optimize engagement by aligning content creation with data-driven
predictions.</p>
</div>
<div id="139c7bc0-03b2-4fff-a10c-b1927ccd56a5" class="cell code">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup - Run only once per Kernel App</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>conda install openjdk <span class="op">-</span>y</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># install PySpark</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install pyspark<span class="op">==</span><span class="fl">3.4.0</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># install spark-nlp</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install spark<span class="op">-</span>nlp<span class="op">==</span><span class="fl">5.1.3</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install plotly</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install tabulate</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># restart kernel</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.core.display <span class="im">import</span> HTML</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>HTML(<span class="st">&quot;&lt;script&gt;Jupyter.notebook.kernel.restart()&lt;/script&gt;&quot;</span>)</span></code></pre></div>
</div>
<div id="319b298f-e9f6-4ef1-a662-dc40a44bd252" class="cell code"
data-execution_count="43" data-tags="[]">
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.types <span class="im">import</span> IntegerType</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml <span class="im">import</span> Pipeline</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> VectorAssembler</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> RandomForestRegressor</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> GBTRegressor</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml <span class="im">import</span> PipelineModel</span></code></pre></div>
</div>
<div id="f5606228-0418-447c-8ff5-3fc83b47cd4a" class="cell code"
data-execution_count="4" data-collapsed="true"
data-jupyter="{&quot;outputs_hidden&quot;:true}" data-tags="[]">
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>spark <span class="op">=</span> (</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    SparkSession.builder.appName(<span class="st">&quot;PySparkApp&quot;</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    .config(<span class="st">&quot;spark.jars.packages&quot;</span>, <span class="st">&quot;org.apache.hadoop:hadoop-aws:3.2.2&quot;</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    .config(</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;fs.s3a.aws.credentials.provider&quot;</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;com.amazonaws.auth.ContainerCredentialsProvider&quot;</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    .getOrCreate()</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>Warning: Ignoring non-Spark config property: fs.s3a.aws.credentials.provider
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>:: loading settings :: url = jar:file:/opt/conda/lib/python3.10/site-packages/pyspark/jars/ivy-2.5.1.jar!/org/apache/ivy/core/settings/ivysettings.xml
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>Ivy Default Cache set to: /root/.ivy2/cache
The jars for the packages stored in: /root/.ivy2/jars
org.apache.hadoop#hadoop-aws added as a dependency
:: resolving dependencies :: org.apache.spark#spark-submit-parent-cb5b606a-59fe-4a7c-b29e-095afb638a8a;1.0
	confs: [default]
	found org.apache.hadoop#hadoop-aws;3.2.2 in central
	found com.amazonaws#aws-java-sdk-bundle;1.11.563 in central
:: resolution report :: resolve 656ms :: artifacts dl 23ms
	:: modules in use:
	com.amazonaws#aws-java-sdk-bundle;1.11.563 from central in [default]
	org.apache.hadoop#hadoop-aws;3.2.2 from central in [default]
	---------------------------------------------------------------------
	|                  |            modules            ||   artifacts   |
	|       conf       | number| search|dwnlded|evicted|| number|dwnlded|
	---------------------------------------------------------------------
	|      default     |   2   |   0   |   0   |   0   ||   2   |   0   |
	---------------------------------------------------------------------
:: retrieving :: org.apache.spark#spark-submit-parent-cb5b606a-59fe-4a7c-b29e-095afb638a8a
	confs: [default]
	0 artifacts copied, 2 already retrieved (0kB/25ms)
23/11/28 01:52:20 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable
Setting default log level to &quot;WARN&quot;.
To adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).
</code></pre>
</div>
</div>
<div id="b2292bdb-5ae7-4004-a764-dae1d34b60b1" class="cell code"
data-execution_count="5" data-collapsed="true"
data-jupyter="{&quot;outputs_hidden&quot;:true}" data-tags="[]">
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sagemaker</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>session <span class="op">=</span> sagemaker.Session()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>bucket <span class="op">=</span> session.default_bucket()</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>output_prefix_data_submissions <span class="op">=</span> <span class="ss">f&quot;project/submissions/yyyy=*&quot;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>s3_path <span class="op">=</span> <span class="ss">f&quot;s3a://</span><span class="sc">{</span>bucket<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>output_prefix_data_submissions<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;reading submissions from </span><span class="sc">{</span>s3_path<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>submissions <span class="op">=</span> spark.read.parquet(s3_path, header<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;shape of the submissions dataframe is </span><span class="sc">{</span>submissions<span class="sc">.</span>count()<span class="sc">:,}</span><span class="ss">x</span><span class="sc">{</span><span class="bu">len</span>(submissions.columns)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>sampled_submissions <span class="op">=</span> submissions.sample(withReplacement<span class="op">=</span><span class="va">False</span>, fraction<span class="op">=</span><span class="fl">0.1</span>, seed<span class="op">=</span><span class="dv">123</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>sagemaker.config INFO - Not applying SDK defaults from location: /etc/xdg/sagemaker/config.yaml
sagemaker.config INFO - Not applying SDK defaults from location: /root/.config/sagemaker/config.yaml
sagemaker.config INFO - Not applying SDK defaults from location: /etc/xdg/sagemaker/config.yaml
sagemaker.config INFO - Not applying SDK defaults from location: /root/.config/sagemaker/config.yaml
reading submissions from s3a://sagemaker-us-east-1-861795727138/project/submissions/yyyy=*
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>23/11/28 01:52:36 WARN MetricsConfig: Cannot locate configuration: tried hadoop-metrics2-s3a-file-system.properties,hadoop-metrics2.properties
23/11/28 01:52:45 WARN package: Truncated the string representation of a plan since it was too large. This behavior can be adjusted by setting &#39;spark.sql.debug.maxToStringFields&#39;.
[Stage 1:========================================================&gt;(96 + 1) / 97]</code></pre>
</div>
<div class="output stream stdout">
<pre><code>shape of the submissions dataframe is 95,932x68
CPU times: user 2.33 s, sys: 178 ms, total: 2.5 s
Wall time: 5min 10s
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div id="5ecfb64a-311d-4fb6-b119-dd728820044d" class="cell code"
data-execution_count="6" data-tags="[]">
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>sampled_topcreators<span class="op">=</span> pd.read_csv(<span class="st">&#39;../../data/csv/sampled_Top100Creators.csv&#39;</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>sampled_topcreators<span class="op">=</span> sampled_topcreators[<span class="st">&#39;author&#39;</span>].to_list()</span></code></pre></div>
</div>
<div id="8cc052c5-3b9b-4ee5-b185-f7845b422d4d" class="cell code"
data-execution_count="7" data-tags="[]">
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>sampled_submissions_var<span class="op">=</span> sampled_submissions.withColumn(<span class="st">&quot;created_hour&quot;</span>,F.hour(F.to_timestamp(F.col(<span class="st">&quot;created_utc&quot;</span>).cast(<span class="st">&#39;int&#39;</span>))))<span class="op">\</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                                            .withColumn(<span class="st">&#39;text_length&#39;</span>,F.length(F.col(<span class="st">&#39;selftext&#39;</span>)))<span class="op">\</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                                            .withColumn(<span class="st">&quot;title_length&quot;</span>, F.length(F.col(<span class="st">&quot;title&quot;</span>)))<span class="op">\</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                                            .withColumn(<span class="st">&quot;is_top_100_creator&quot;</span>, F.col(<span class="st">&quot;author&quot;</span>).isin(sampled_topcreators))<span class="op">\</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                                            .withColumn(<span class="st">&quot;is_peak_hour&quot;</span>, F.col(<span class="st">&quot;created_hour&quot;</span>).isin([<span class="dv">16</span>, <span class="dv">17</span>, <span class="dv">18</span>, <span class="dv">19</span>, <span class="dv">20</span>, <span class="dv">21</span>, <span class="dv">22</span>, <span class="dv">23</span>, <span class="dv">0</span>]))<span class="op">\</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>                                            .withColumn(<span class="st">&quot;has_media&quot;</span>, F.col(<span class="st">&quot;media&quot;</span>).isNotNull() <span class="op">|</span> F.col(<span class="st">&quot;media_embed&quot;</span>).getField(<span class="st">&#39;content&#39;</span>).isNotNull())<span class="op">\</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                                            .withColumn(<span class="st">&quot;is_long_text&quot;</span>,(F.col(<span class="st">&#39;text_length&#39;</span>) <span class="op">&gt;</span> <span class="dv">200</span>))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Dummy submissions varaibles</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>sampled_submissions_var<span class="op">=</span> sampled_submissions_var.withColumn(<span class="st">&quot;skincare&quot;</span>,F.col(<span class="st">&quot;selftext&quot;</span>).rlike(<span class="st">&quot;&quot;&quot;(?i)body|(?i)hair|(?i)facial|(?i)nails|(?i)lip|(?i)sunscreen|(?i)SPF|(?i)acne|(?i)pimples|(?i)scar|(?i)aging&quot;&quot;&quot;</span>))<span class="op">\</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>                                  .withColumn(<span class="st">&quot;skincare_product&quot;</span>,F.col(<span class="st">&quot;selftext&quot;</span>).rlike(<span class="st">&quot;&quot;&quot;(?i)moisturizer|(?i)cleanser|(?i)serum|(?i)toner|(?i)lotion&quot;&quot;&quot;</span>))<span class="op">\</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>                                  .withColumn(<span class="st">&quot;skincare_product_brand&quot;</span>,F.col(<span class="st">&quot;selftext&quot;</span>).rlike(<span class="st">&quot;&quot;&quot;(?i)Clinique|(?i)Neutrogena|(?i)Cetaphil|(?i)Kiehl&#39;s|(?i)Olay&quot;&quot;&quot;</span>))<span class="op">\</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>                                  .withColumn(<span class="st">&quot;makeup&quot;</span>,F.col(<span class="st">&quot;selftext&quot;</span>).rlike(<span class="st">&quot;&quot;&quot;(?i)beauty|(?i)bodypaint|(?i)cosmetics|(?i)style|(?i)artist|(?i)cosplay|(?i)fashion|(?i)celebrity|(?i)party|(?i)wedding|(?i)palette&quot;&quot;&quot;</span>))<span class="op">\</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>                                  .withColumn(<span class="st">&quot;makeup_product&quot;</span>,F.col(<span class="st">&quot;selftext&quot;</span>).rlike(<span class="st">&quot;&quot;&quot;(?i)eyeliner|(?i)contour|(?i)foundation|(?i)blush|(?i)lipstick|(?i)concealer&quot;&quot;&quot;</span>))<span class="op">\</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>                                  .withColumn(<span class="st">&quot;makeup_product_brand&quot;</span>,F.col(<span class="st">&quot;selftext&quot;</span>).rlike(<span class="st">&quot;&quot;&quot;(?i)MAC|(?i)NARS|(?i)Sephora|(?i)Fenty|(?i)Revlon|(?i)NYX|(?i)L&#39;Oreal|(?i)Maybelline&quot;&quot;&quot;</span>))</span></code></pre></div>
</div>
<div id="5b29333c-2a17-4670-948a-101281889873" class="cell code"
data-execution_count="8" data-tags="[]">
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List of columns to select as independent variables</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>independent_vars <span class="op">=</span> [</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;is_top_100_creator&quot;</span>, <span class="st">&quot;text_length&quot;</span>, <span class="st">&quot;title_length&quot;</span>, <span class="st">&quot;archived&quot;</span>, <span class="st">&quot;is_peak_hour&quot;</span>, <span class="st">&quot;gilded&quot;</span>, <span class="st">&quot;hidden&quot;</span>, <span class="st">&quot;hide_score&quot;</span>, <span class="st">&quot;is_crosspostable&quot;</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;is_reddit_media_domain&quot;</span>, <span class="st">&quot;is_self&quot;</span>, <span class="st">&quot;is_video&quot;</span>, <span class="st">&quot;num_crossposts&quot;</span>, <span class="st">&quot;over_18&quot;</span>, <span class="st">&quot;has_media&quot;</span>, <span class="st">&quot;pinned&quot;</span>, <span class="st">&quot;score&quot;</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;spoiler&quot;</span>, <span class="st">&quot;stickied&quot;</span>, <span class="st">&quot;is_long_text&quot;</span>, <span class="st">&quot;skincare&quot;</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;skincare_product&quot;</span>, <span class="st">&quot;skincare_product_brand&quot;</span>, <span class="st">&quot;makeup&quot;</span>, <span class="st">&quot;makeup_product&quot;</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;makeup_product_brand&quot;</span>,<span class="st">&quot;num_comments&quot;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Selecting the independent variables from the DataFrame</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>sampled_sub_ml <span class="op">=</span> sampled_submissions_var.select(independent_vars)</span></code></pre></div>
</div>
<div id="dee622f3-a12e-47a3-bf53-d2b5271ffce5" class="cell code"
data-execution_count="9" data-collapsed="true"
data-jupyter="{&quot;outputs_hidden&quot;:true}" data-tags="[]">
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>sampled_sub_ml.printSchema()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>root
 |-- is_top_100_creator: boolean (nullable = true)
 |-- text_length: integer (nullable = true)
 |-- title_length: integer (nullable = true)
 |-- archived: boolean (nullable = true)
 |-- is_peak_hour: boolean (nullable = true)
 |-- gilded: long (nullable = true)
 |-- hidden: boolean (nullable = true)
 |-- hide_score: boolean (nullable = true)
 |-- is_crosspostable: boolean (nullable = true)
 |-- is_reddit_media_domain: boolean (nullable = true)
 |-- is_self: boolean (nullable = true)
 |-- is_video: boolean (nullable = true)
 |-- num_crossposts: long (nullable = true)
 |-- over_18: boolean (nullable = true)
 |-- has_media: boolean (nullable = false)
 |-- pinned: boolean (nullable = true)
 |-- score: long (nullable = true)
 |-- spoiler: boolean (nullable = true)
 |-- stickied: boolean (nullable = true)
 |-- is_long_text: boolean (nullable = true)
 |-- skincare: boolean (nullable = true)
 |-- skincare_product: boolean (nullable = true)
 |-- skincare_product_brand: boolean (nullable = true)
 |-- makeup: boolean (nullable = true)
 |-- makeup_product: boolean (nullable = true)
 |-- makeup_product_brand: boolean (nullable = true)
 |-- num_comments: long (nullable = true)

</code></pre>
</div>
</div>
<div id="6a69b3fa-ad98-4324-9e72-a1861c6ca068" class="cell code"
data-execution_count="29" data-tags="[]">
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># label and feature columns setup</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>label_col <span class="op">=</span> <span class="st">&quot;score&quot;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>feature_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> sampled_sub_ml.columns <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> [<span class="st">&#39;score&#39;</span>]]</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Split Data</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>(train_data, test_data) <span class="op">=</span> sampled_sub_ml.randomSplit([<span class="fl">0.8</span>, <span class="fl">0.2</span>], seed<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>train_data.cache()</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>test_data.cache()</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create VectorAssembler</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>assembler <span class="op">=</span> VectorAssembler(inputCols<span class="op">=</span>feature_cols, outputCol<span class="op">=</span><span class="st">&quot;features&quot;</span>)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>23/11/28 02:40:38 WARN CacheManager: Asked to cache already cached data.
</code></pre>
</div>
</div>
<div id="22b4a497-510a-47b3-a918-cbef1947d826" class="cell markdown"
data-tags="[]">
<h2 id="model-1---random-forest-regressor">Model 1 - Random Forest
Regressor</h2>
</div>
<div id="35693a52-9d18-4087-b2b1-054b6fa146d0" class="cell code"
data-execution_count="11" data-tags="[]">
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and Train RandomForestRegressor</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>rf <span class="op">=</span> RandomForestRegressor(labelCol<span class="op">=</span>label_col, featuresCol<span class="op">=</span><span class="st">&quot;features&quot;</span>, numTrees<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> Pipeline(stages<span class="op">=</span>[assembler, rf])</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the model</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>model_rf <span class="op">=</span> pipeline.fit(train_data)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div id="ab41dc8c-6e4e-46e5-a733-0c977480ad86" class="cell markdown">
<h2 id="model-2--gradient-boosted-trees-gbt-regressor">Model 2-
Gradient-Boosted Trees (GBT) regressor</h2>
</div>
<div id="8ca234be-bed1-4413-8e1b-ee81c60ecde5" class="cell code"
data-execution_count="15" data-tags="[]">
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create GBTRegressor</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>gbt <span class="op">=</span> GBTRegressor(labelCol<span class="op">=</span>label_col, featuresCol<span class="op">=</span><span class="st">&quot;features&quot;</span>, maxIter<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> Pipeline(stages<span class="op">=</span>[assembler, gbt])</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the model</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>model_gbt <span class="op">=</span> pipeline.fit(train_data)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div id="af70b057-4f17-420e-8c88-c231409bf829" class="cell markdown">
<h2 id="results-and-comparasion">Results and Comparasion</h2>
</div>
<div id="647d3e45-25b1-427d-ad94-7808ccca01c1" class="cell code"
data-execution_count="27" data-tags="[]">
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make predictions on the test set</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>predictions_rf<span class="op">=</span> model_rf.transform(test_data)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>predictions_rf <span class="op">=</span> predictions_rf.select(<span class="st">&quot;prediction&quot;</span>, label_col)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate the model</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span>label_col, predictionCol<span class="op">=</span><span class="st">&quot;prediction&quot;</span>, metricName<span class="op">=</span><span class="st">&quot;mae&quot;</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>mae_rf <span class="op">=</span> evaluator.evaluate(predictions_rf)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span>label_col, predictionCol<span class="op">=</span><span class="st">&quot;prediction&quot;</span>, metricName<span class="op">=</span><span class="st">&quot;rmse&quot;</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>rmse_rf <span class="op">=</span> evaluator.evaluate(predictions_rf)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span>label_col, predictionCol<span class="op">=</span><span class="st">&quot;prediction&quot;</span>, metricName<span class="op">=</span><span class="st">&quot;r2&quot;</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>r2_rf <span class="op">=</span> evaluator.evaluate(predictions_rf)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>WARNING: An illegal reflective access operation has occurred
WARNING: Illegal reflective access by org.apache.spark.util.SizeEstimator$ (file:/opt/conda/lib/python3.10/site-packages/pyspark/jars/spark-core_2.12-3.4.0.jar) to field java.nio.charset.Charset.name
WARNING: Please consider reporting this to the maintainers of org.apache.spark.util.SizeEstimator$
WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations
WARNING: All illegal access operations will be denied in a future release
[Stage 326:======================================================&gt;(96 + 1) / 97]</code></pre>
</div>
<div class="output stream stdout">
<pre><code>RandomForestRegressor:
Mean Absolute Error: 64.29881695303378
Root Mean Squared Error: 231.18777300014239
R-squared: 0.7265410321571694
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div id="27c7b4b1-926f-4de3-b46e-a5d4aafda177" class="cell code"
data-execution_count="30" data-tags="[]">
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make predictions on the test set</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>predictions_gbt<span class="op">=</span> model_gbt.transform(test_data)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>predictions_gbt <span class="op">=</span> predictions_gbt.select(<span class="st">&quot;prediction&quot;</span>, label_col)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate the model</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span>label_col, predictionCol<span class="op">=</span><span class="st">&quot;prediction&quot;</span>, metricName<span class="op">=</span><span class="st">&quot;mae&quot;</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>mae_gbt <span class="op">=</span> evaluator.evaluate(predictions_gbt)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span>label_col, predictionCol<span class="op">=</span><span class="st">&quot;prediction&quot;</span>, metricName<span class="op">=</span><span class="st">&quot;rmse&quot;</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>rmse_gbt <span class="op">=</span> evaluator.evaluate(predictions_gbt)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span>label_col, predictionCol<span class="op">=</span><span class="st">&quot;prediction&quot;</span>, metricName<span class="op">=</span><span class="st">&quot;r2&quot;</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>r2_gbt <span class="op">=</span> evaluator.evaluate(predictions_gbt)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>23/11/28 02:40:54 WARN InstanceBuilder: Failed to load implementation from:dev.ludovic.netlib.blas.JNIBLAS
[Stage 332:==========================================&gt;            (75 + 2) / 97]</code></pre>
</div>
<div class="output stream stdout">
<pre><code>Gradient-Boosted Trees (GBT) regressor:
Mean Absolute Error: 59.71954489757257
Root Mean Squared Error: 245.67493725127667
R-squared: 0.6911951199787334
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div id="4631c9cf-8fb3-4411-a110-e6efbf38abad" class="cell code"
data-execution_count="34" data-tags="[]">
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw a table to compare the evaluation results of two models</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> [</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    [<span class="st">&quot;Random Forest&quot;</span>, mae_rf, rmse_rf, r2_rf],</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    [<span class="st">&quot;Gradient Boosted Trees&quot;</span>, mae_gbt, rmse_gbt, r2_gbt],</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the headers for the table</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>headers <span class="op">=</span> [<span class="st">&quot;Model&quot;</span>, <span class="st">&quot;MAE&quot;</span>, <span class="st">&quot;RMSE&quot;</span>, <span class="st">&quot;R-squared&quot;</span>]</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the table</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> tabulate(data, headers, tablefmt<span class="op">=</span><span class="st">&quot;pretty&quot;</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(table)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+------------------------+-------------------+--------------------+--------------------+
|         Model          |        MAE        |        RMSE        |     R-squared      |
+------------------------+-------------------+--------------------+--------------------+
|     Random Forest      | 64.29881695303378 | 231.18777300014239 | 0.7265410321571694 |
| Gradient Boosted Trees | 59.71954489757257 | 245.67493725127667 | 0.6911951199787334 |
+------------------------+-------------------+--------------------+--------------------+
</code></pre>
</div>
</div>
<div id="a1d03d2e-ee7c-4210-a9ce-b5645193a41a" class="cell markdown">
<p>Based on the provided metrics:</p>
<ul>
<li><p>The Random Forest model has a slightly higher R-squared value
(0.727) compared to the GBT model (0.691), indicating that a higher
proportion of the variance in the target variable is explained by the
Random Forest model.</p></li>
<li><p>However, the GBT model has a lower MAE (59.72) compared to the
Random Forest model (64.30), suggesting that, on average, the
predictions from the GBT model are closer to the actual values.</p></li>
</ul>
<p>If our primary goal is to minimize prediction errors, especially in
terms of Mean Absolute Error (MAE), the GBT model stands out as the
preferred choice. The model's accuracy is held in high regard, making it
a reliable option. Furthermore, by considering additional factors such
as the number of comments, whether the author is among the top creators,
and the word count of the submission, we can enhance our ability to
predict the submission score with greater precision, bringing our
predictions closer to the actual figures.</p>
<p>If our emphasis is on elucidating a greater proportion of variance in
the target variable, particularly with regard to R-squared, the Random
Forest model emerges as the model of choice. Examining the feature
importance of the model enables us to delve into its distribution,
offering insights into what factors are crucial for achieving a high
score when posting. For instance, becoming a top creator may involve
writing more extensive titles and selftext, posting during peak hours,
actively engaging with other submissions, and striving to attract a
higher number of comments, if feasible.</p>
<p>Consider the trade-offs between different metrics, I will choose
Random Forest model, which better fits into our original business
goal.</p>
</div>
<div id="0136e9be-461b-4601-9016-5c61715d4166" class="cell code"
data-execution_count="38" data-tags="[]">
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get feature importances</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>feature_importances <span class="op">=</span> model_rf.stages[<span class="op">-</span><span class="dv">1</span>].featureImportances</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract feature names</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>feature_names <span class="op">=</span> assembler.getInputCols()</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert SparseVector to dense format</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>importance_values <span class="op">=</span> feature_importances.toArray()</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DataFrame for visualization</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>importance_df <span class="op">=</span> pd.DataFrame({<span class="st">&#39;Feature&#39;</span>: feature_names, <span class="st">&#39;Importance&#39;</span>: importance_values})</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter out features with zero importance</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>importance_df_filtered <span class="op">=</span> importance_df[importance_df[<span class="st">&#39;Importance&#39;</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the DataFrame by importance in descending order</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>importance_df_filtered <span class="op">=</span> importance_df_filtered.sort_values(by<span class="op">=</span><span class="st">&#39;Importance&#39;</span>, ascending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an interactive bar chart using Plotly</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.bar(importance_df_filtered, x<span class="op">=</span><span class="st">&#39;Importance&#39;</span>, y<span class="op">=</span><span class="st">&#39;Feature&#39;</span>, orientation<span class="op">=</span><span class="st">&#39;h&#39;</span>, title<span class="op">=</span><span class="st">&#39;Random Forest Feature Importances (Non-zero)&#39;</span>)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>fig.update_layout(height<span class="op">=</span><span class="dv">600</span>, width<span class="op">=</span><span class="dv">800</span>, margin<span class="op">=</span><span class="bu">dict</span>(l<span class="op">=</span><span class="dv">20</span>, r<span class="op">=</span><span class="dv">20</span>, t<span class="op">=</span><span class="dv">40</span>, b<span class="op">=</span><span class="dv">40</span>))</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>fig.write_html(<span class="st">&quot;../../data/plots/score_pred_rf_feature_importance_nonzero.html&quot;</span>)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code></pre></div>
<div class="output display_data">
<div>                            <div id="00cd4ef3-e63f-4d6a-94e7-df7255330786" class="plotly-graph-div" style="height:600px; width:800px;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("00cd4ef3-e63f-4d6a-94e7-df7255330786")) {                    Plotly.newPlot(                        "00cd4ef3-e63f-4d6a-94e7-df7255330786",                        [{"alignmentgroup":"True","hovertemplate":"Importance=%{x}<br>Feature=%{y}<extra></extra>","legendgroup":"","marker":{"color":"#636efa","pattern":{"shape":""}},"name":"","offsetgroup":"","orientation":"h","showlegend":false,"textposition":"auto","x":[1.4848497432867258e-09,2.7475246662278255e-08,6.897079521341988e-08,1.3619443086789896e-05,0.00011381249490571965,0.00022064013439506344,0.0003590636956402358,0.0004960576570355524,0.0007027774115188499,0.001086074572695135,0.0031793872523212486,0.004728591143801288,0.010020747504803315,0.013379781922064673,0.013497809397311315,0.02118391546622636,0.06857723724796701,0.0876376791002852,0.09334493375540728,0.20328491746314137,0.4781728564065022],"xaxis":"x","y":["skincare_product","skincare_product_brand","is_video","spoiler","makeup_product_brand","has_media","makeup","makeup_product","skincare","over_18","is_long_text","is_self","is_peak_hour","is_reddit_media_domain","is_crosspostable","text_length","title_length","num_crossposts","gilded","is_top_100_creator","num_comments"],"yaxis":"y","type":"bar"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"xaxis":{"anchor":"y","domain":[0.0,1.0],"title":{"text":"Importance"}},"yaxis":{"anchor":"x","domain":[0.0,1.0],"title":{"text":"Feature"}},"legend":{"tracegroupgap":0},"title":{"text":"Random Forest Feature Importances (Non-zero)"},"barmode":"relative","margin":{"l":20,"r":20,"t":40,"b":40},"height":600,"width":800},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('00cd4ef3-e63f-4d6a-94e7-df7255330786');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
</div>
</div>
<div id="c1bd0eae-2906-423f-9d57-8bb348722ede" class="cell markdown">
<ol>
<li><strong>Highly Important Features:</strong>
<ul>
<li><p><code>num_comments</code>: This feature has the highest
importance (0.478), indicating that the number of comments on a
submission is a crucial factor in predicting the score.</p></li>
<li><p><code>is_top_100_creator</code>: This feature also has
significant importance (0.203), suggesting that whether the creator is
in the top 100 contributors is influential.</p></li>
<li><p><code>gilded</code>: The feature indicating whether the
submission received gold awards (<code>gilded</code>) is also important
(0.093), implying that highly recognized or appreciated posts tend to
have higher scores.</p></li>
<li><p><code>num_crossposts</code>: The number of crossposts
(<code>num_crossposts</code>) also plays a notable role (0.088) in
predicting the score.</p></li>
</ul></li>
<li><strong>Moderate Importance Features:</strong>
<ul>
<li><p><code>title_length</code>: The length of the submission title
contributes moderately (0.069).</p></li>
<li><p><code>is_crosspostable</code>,
<code>is_reddit_media_domain</code>: These features related to
crossposting and being from Reddit's media domain contribute
moderately.</p></li>
</ul></li>
<li><strong>Low Importance Features:</strong>
<ul>
<li>Several features, such as <code>text_length</code>,
<code>is_peak_hour</code>, <code>is_self</code>,
<code>is_long_text</code>, and others, have lower importances but still
contribute to the model.</li>
</ul></li>
</ol>
<p><strong>Interpretation:</strong></p>
<ul>
<li><p>The model emphasizes the engagement metrics
(<code>num_comments</code>, <code>num_crossposts</code>,
<code>gilded</code>) and characteristics of the submission creator
(<code>is_top_100_creator</code>) as highly influential in predicting
the score.</p></li>
<li><p>Features related to the content of the submission, such as
<code>title_length</code>, also play a significant role.</p></li>
</ul>
</div>
<div id="cbfe9d3f-fd61-488c-8820-d3c74fd80d8e" class="cell code"
data-execution_count="44">
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the model</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>model_path <span class="op">=</span> <span class="st">&quot;score_pred_model_rf&quot;</span> </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>model_rf.write().overwrite().save(model_path)</span></code></pre></div>
</div>
</body>
</html>
